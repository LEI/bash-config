#!/usr/bin/env bash

ROOT="$(cd "$(dirname "$BASH_SOURCE")"; pwd -P)"

# declare -l OS
# OS="$(uname -o 2>/dev/null || uname -s)"
# OS="$(echo "$OS" | tr '[:upper:]' '[:lower:]')"

for f in $ROOT/lib/*.bash
do source "$f"
done

check() {
  echo check "$@"
  if [[ $# -ne 0 ]] && [[ -n "$1" ]]
  then err "$1: action already defined"
    return 1
  fi
}

prompt() {
  local q="$1"
  local d="$2"
  >&2 log "$q"
  local reply
  read -r reply
  # read -p "$q" -i "$d" -e vareply
  log "${reply:-$d}"
}

main() {
  detect_os || return 1
  RUN="${RUN:-1}"
  local a action="install"
  local update=0
  local pkg=()
  [[ $# -eq 0 ]] && update=1
  while [[ $# -ne 0 ]]
  do case "$1" in
      --) break ;;
      -I|--install) check "$a" && a="install" || return 1 ;;
      -D|--delete) check "$a" && a="delete" || return 1 ;;
      -d|--dry-run) RUN=0 ;;
      -u|--update) update="$(($update + 1))" ;;
      --*|'') err "$1: illegal option"; return 1 ;;
      -*) if [[ "$1" =~ ^-[a-zA-Z][a-zA-Z]+$ ]] && [[ "${1:1:1}" =~ [IDdu] ]]
        then set -- "${1:0:2}" "-${1:2}" "${@:2}"; continue
        else err "${1:0:2}: illegal option"; return 1
        fi
        ;;
      *) pkg+=("$1") ;; # pkg+=("$@"); break
    esac
    shift
  done

  local v var val
  if [[ " ${pkg[@]} " == " git " ]]
  then
    for v in "GIT_AUTHOR_NAME:What is your github full name?" \
      "GIT_AUTHOR_USERNAME:What is your github username?" \
      "GIT_AUTHOR_EMAIL:What is your github email?"
    do var="${v%%:*}"; val="$(prompt "${v#*:} (default: ${!var}) " "${!var}")"
      declare $var="$val" && export $var
    done
  fi

  log "Bootstrap: $OS"
  [[ "$update" -ne 0 ]] && pkg_update
  local path="$ROOT/os_$OS/packages" # ${PKG_CMD%%-*}
  if [[ -f "$path" ]]
  then pkg_$action $(cat "$path")
  else err "$path: no such file"
  fi

  if has stow
  then case "$action" in
      install) state="present" ;;
      delete) state="absent" ;;
    esac
   find_stow "$state" "${pkg[@]}"
  fi

  log "Done."
}

# [[ "$0" == "$BASH_SOURCE" ]]
main "$@"
