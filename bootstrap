#!/usr/bin/env bash

# Usage: source bootstrap

BOOTSTRAP="$(dirname "${BASH_SOURCE}")"

log() {
  # printf "%s" "${0##*/}: "
  printf "%s\n" "$@"
}

err() {
  local ret=$?
  >&2 log "$@"
  return $ret
}

has() {
  if ! hash "$1" 2>/dev/null
  then err "$1: command not found"
    return 127
  fi
}

# Install packages
apt_packages() {
  local pkg="${1:-$BOOTSTRAP/apt}"

  if [[ -r "$pkg" ]]
  then pkg="$(cat "$pkg")"
  else err "$pkg: not found"
    return 1
  fi

  log "Updating available packages..."
  apt update && apt install $pkg
}

# Symlink dotfiles
stow_packages() {
  local path="${1:-$BOOTSTRAP/*}"
  local target="${2:-$HOME}"

  # local d
  # for d in {.vim,.tmux}
  # do d="$TARGET/$d"
  #   [[ -d "$d" ]] || mkdir "$d"
  # done

  # local ignore_dirs=
  # [[ "$ignore_dirs" != *"$pkg"* ]]

  if [[ -d "$path/os_$OS" ]]
  then path+=" $path/os_*"
  fi

  local fcmd="find $path -type d ! -name 'os_*' \
    -mindepth 1 -maxdepth 1"
  local packages="$($fcmd)"

  echo "FIND: $fcmd => $packages"

  local d
  for d in $packages
  do local pkg="$(basename $d)"
    local dir="$(dirname $d)"
    log "Stowing $pkg..."
    stow --verbose --ignore=".*.tpl" \
      --dir "$dir" --target \
      "$target" "$pkg"
  done
}

git_install() {
  local tpl="${1:-$BOOTSTRAP/git/.gitconfig.local.tpl}"
  if [[ ! -f "$tpl" ]] && [[ ! -L "$tpl" ]]
  then err "$tpl: not found"
    return 1
  fi
  local dst="${2:-$HOME}/.gitconfig.local"
  if [[ -f "$dst" ]] || [[ -L "$dst" ]]
  then err "${dst/$HOME/\~}: already exists"
    return
  fi
  local git_name git_user git_email
  log "What is your github full name?"
  read -e git_name
  log "What is your github username?"
  read -e git_user
  log "What is your github email?"
  read -e git_email
  sed -e "s/GIT_NAME/$git_name/g" \
    -e "s/GIT_USERNAME/$git_username/g" \
    -e "s/GIT_EMAIL/$git_email/g" \
    "$tpl" > "$dst"
}

main() {
  case "$(uname -o 2>/dev/null)" in
    Android) OS="android" ;;
    *) OS="$(uname -s | to lower)" ;;
  esac

  if has apt
  then apt_packages
  fi

  if has stow
  then stow_packages
  fi

  if has git
  then git_install
  fi

  log "Done."
}

main "$@"

unset log
unset err
unset has
unset apt_packages
unset stow_packages
unset git_install
unset main
